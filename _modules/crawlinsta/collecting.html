<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>crawlinsta.collecting &mdash; Instagram Crawler 0.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/autodoc_pydantic.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=2389946f"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Instagram Crawler
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../01_about.html">Crawlinsta</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02_source.html">Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Instagram Crawler</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">crawlinsta.collecting</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for crawlinsta.collecting</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">parse_qs</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Json</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">ActionChains</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.by</span> <span class="kn">import</span> <span class="n">By</span>
<span class="kn">from</span> <span class="nn">seleniumwire.webdriver</span> <span class="kn">import</span> <span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">.schemas</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">UserBasicInfo</span><span class="p">,</span> <span class="n">UserProfile</span><span class="p">,</span> <span class="n">UserInfo</span><span class="p">,</span> <span class="n">Users</span><span class="p">,</span> <span class="n">Liker</span><span class="p">,</span> <span class="n">Likers</span><span class="p">,</span> <span class="n">Comments</span><span class="p">,</span>
    <span class="n">Caption</span><span class="p">,</span> <span class="n">PostBasicInfo</span><span class="p">,</span> <span class="n">Posts</span><span class="p">,</span> <span class="n">MusicPosts</span><span class="p">,</span> <span class="n">HashtagBasicInfo</span><span class="p">,</span>
    <span class="n">HashtagBasicInfos</span><span class="p">,</span> <span class="n">Hashtag</span><span class="p">,</span> <span class="n">SearchingResultHashtag</span><span class="p">,</span> <span class="n">SearchingResultUser</span><span class="p">,</span>
    <span class="n">LocationBasicInfo</span><span class="p">,</span> <span class="n">Place</span><span class="p">,</span> <span class="n">SearchingResultPlace</span><span class="p">,</span> <span class="n">SearchingResult</span><span class="p">,</span>
    <span class="n">FriendshipStatus</span><span class="p">,</span> <span class="n">Music</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">search_request</span><span class="p">,</span> <span class="n">get_json_data</span><span class="p">,</span> <span class="n">filter_requests</span>
<span class="kn">from</span> <span class="nn">.decorators</span> <span class="kn">import</span> <span class="n">driver_implicit_wait</span>
<span class="kn">from</span> <span class="nn">.data_extraction</span> <span class="kn">import</span> <span class="n">extract_post</span><span class="p">,</span> <span class="n">extract_id</span><span class="p">,</span> <span class="n">extract_music_info</span><span class="p">,</span> <span class="n">extract_sound_info</span>

<span class="n">INSTAGRAM_DOMAIN</span> <span class="o">=</span> <span class="s2">&quot;https://www.instagram.com&quot;</span>
<span class="n">GRAPHQL_QUERY_PATH</span> <span class="o">=</span> <span class="s2">&quot;graphql/query&quot;</span>
<span class="n">API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;api/v1&quot;</span>
<span class="n">FOLLOWING_DOC_ID</span> <span class="o">=</span> <span class="s2">&quot;17901966028246171&quot;</span>
<span class="n">TAGGED_POST_DOC_ID</span> <span class="o">=</span> <span class="s2">&quot;17946422347485809&quot;</span>


<div class="viewcode-block" id="collect_user_info"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_user_info">[docs]</a><span class="nd">@driver_implicit_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">collect_user_info</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                      <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect user information through username, including user_id, username,</span>
<span class="sd">    profile_pic_url, biography, post_count, follower_count, following_count.</span>

<span class="sd">    Strategy: click the username, get to the main page of the user, the user</span>
<span class="sd">    information is returned in the response body.</span>

<span class="sd">    Alternatively, put the mouse over the user&#39;s name in home page, the user</span>
<span class="sd">    information will show in a popup. A request triggered by the mouseover was</span>
<span class="sd">    sent to the path `/api/v1/users/&lt;user_id&gt;/info/` or</span>
<span class="sd">    `/api/v1/users/web_profile_info/?username=&lt;user_name&gt;`</span>

<span class="sd">    Args:</span>
<span class="sd">        driver (:obj:`selenium.webdriver.remote.webdriver.WebDriver`): selenium</span>
<span class="sd">         driver for controlling the browser to perform certain actions.</span>
<span class="sd">        username (str): name of the user.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: user information in json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_user_info</span>
<span class="sd">        &gt;&gt;&gt; collect_user_info(driver, &quot;instagram_username&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/users/web_profile_info/?username=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">extract_id</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>

    <span class="n">following_btn_xpath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;//a[@href=&#39;/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">/following/&#39;][@role=&#39;link&#39;]&quot;</span>
    <span class="n">following_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="n">following_btn_xpath</span><span class="p">)</span>
    <span class="n">following_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">hashtag_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//span[text()=&#39;Hashtags&#39;]&quot;</span><span class="p">)</span>
    <span class="n">hashtag_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">doc_id</span><span class="o">=</span><span class="n">FOLLOWING_DOC_ID</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">GRAPHQL_QUERY_PATH</span><span class="si">}</span><span class="s2">/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">following_hashtags_number</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;edge_following_hashtag&#39;</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">UserInfo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                      <span class="n">username</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                      <span class="n">fullname</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">],</span>
                      <span class="n">profile_pic_url</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;profile_pic_url&quot;</span><span class="p">],</span>
                      <span class="n">is_private</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;is_private&quot;</span><span class="p">],</span>
                      <span class="n">is_verified</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;is_verified&quot;</span><span class="p">],</span>
                      <span class="n">follower_count</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;edge_followed_by&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
                      <span class="n">following_count</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;edge_follow&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
                      <span class="n">following_tag_count</span><span class="o">=</span><span class="n">following_hashtags_number</span><span class="p">,</span>
                      <span class="n">post_count</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;edge_owner_to_timeline_media&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
                      <span class="n">biography</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;biography&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_posts_of_user"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_posts_of_user">[docs]</a><span class="nd">@driver_implicit_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">collect_posts_of_user</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                          <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect n posts of the given user.</span>

<span class="sd">    Strategy: click the username, get to the main page of the user, a few posts</span>
<span class="sd">    are displayed in the user&#39;s main page. The request was sent to the path</span>
<span class="sd">    `/api/v1/feed/user/&lt;user_name&gt;/username/?count=6` to get the posts and a</span>
<span class="sd">    next_max_id for loading other posts. To load the other posts, move the mouse</span>
<span class="sd">    to the bottom of the page, it will trigger another request sent to</span>
<span class="sd">    `/api/v1/feed/user/&lt;user_id&gt;/?count=12&amp;max_id=&lt;next_max_id&gt;`</span>
<span class="sd">    to have more posts.</span>

<span class="sd">    Args:</span>
<span class="sd">        driver (:obj:`selenium.webdriver.remote.webdriver.WebDriver`): selenium</span>
<span class="sd">         driver for controlling the browser to perform certain actions.</span>
<span class="sd">        username (str): name of the user.</span>
<span class="sd">        n (int): maximum number of posts, which should be collected. By default,</span>
<span class="sd">         it&#39;s 100. If it&#39;s set to 0, collect all posts.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: all visible post of the given user in json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_posts_of_user</span>
<span class="sd">        &gt;&gt;&gt; collect_posts_of_user(driver, &quot;instagram_username&quot;, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;n&#39; must be bigger than or equal to 0.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>
    <span class="c1"># get first 12 documents</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/feed/user/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">/username/?count=12&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">-=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;num_results&quot;</span><span class="p">]</span>

    <span class="k">while</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;more_available&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">footer</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//footer&quot;</span><span class="p">)</span>
        <span class="n">ActionChains</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span><span class="o">.</span><span class="n">scroll_to_element</span><span class="p">(</span><span class="n">footer</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

        <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/feed/user/</span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/?count=12&amp;max_id=</span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;next_max_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">-=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;num_results&quot;</span><span class="p">]</span>

    <span class="n">posts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">extract_post</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">posts</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Posts</span><span class="p">(</span><span class="n">posts</span><span class="o">=</span><span class="n">posts</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">posts</span><span class="p">))</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_reels_of_user"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_reels_of_user">[docs]</a><span class="nd">@driver_implicit_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">collect_reels_of_user</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                          <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect n reels of the given user.</span>

<span class="sd">    Strategy: click the username, get to the main page of the user, a few posts</span>
<span class="sd">    are displayed in the user&#39;s main page. Click the button reels to see all the</span>
<span class="sd">    reels from the user.The request was sent to the path</span>
<span class="sd">    `/api/v1/feed/user/&lt;user_name&gt;/username/?count=6` to get the posts/reels and a</span>
<span class="sd">    next_max_id for loading other posts/reels. To load the other posts/reels,</span>
<span class="sd">    move the mouse to the bottom of the page, it will trigger another request sent to</span>
<span class="sd">    `/api/v1/feed/user/&lt;user_id&gt;/?count=12&amp;max_id=&lt;next_max_id&gt;`</span>
<span class="sd">    to have more posts/reels.</span>

<span class="sd">    Args:</span>
<span class="sd">        driver (:obj:`selenium.webdriver.remote.webdriver.WebDriver`): selenium</span>
<span class="sd">         driver for controlling the browser to perform certain actions.</span>
<span class="sd">        username (str): name of the user.</span>
<span class="sd">        n (int): maximum number of reels, which should be collected. By default,</span>
<span class="sd">         it&#39;s 100. If it&#39;s set to 0, collect all posts.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: all visible reels user information of the given user in json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_reels_of_user</span>
<span class="sd">        &gt;&gt;&gt; collect_reels_of_user(driver, &quot;instagram_username&quot;, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;n&#39; must be bigger than or equal to 0.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">/reels/&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="c1"># get first 12 documents</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/clips/user/&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span>

    <span class="k">while</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;paging_info&#39;</span><span class="p">][</span><span class="s1">&#39;more_available&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">footer</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//footer&quot;</span><span class="p">)</span>
        <span class="n">ActionChains</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span><span class="o">.</span><span class="n">scroll_to_element</span><span class="p">(</span><span class="n">footer</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span>

    <span class="n">posts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">extract_post</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">])</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">posts</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Posts</span><span class="p">(</span><span class="n">posts</span><span class="o">=</span><span class="n">posts</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">posts</span><span class="p">))</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_user_tagged_posts"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_user_tagged_posts">[docs]</a><span class="k">def</span> <span class="nf">collect_user_tagged_posts</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                              <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect n posts in which user was tagged.</span>

<span class="sd">    Strategy: click the username, get to the main page of the user, a few posts</span>
<span class="sd">    are displayed in the user&#39;s main page. Click the button tagged to see all the</span>
<span class="sd">    posts in which the user was tagged.The request was sent to the path</span>
<span class="sd">    `/&lt;user_name&gt;/tagged/` to get the tagged posts/reels and a next_max_id for</span>
<span class="sd">    loading other posts/reels. To load the other posts/reels, move the mouse to</span>
<span class="sd">    the bottom of the page, it will trigger another request sent to the path</span>
<span class="sd">    /graphql/query/?doc_id=&lt;tagged_user_id&gt;&amp;variables=&lt;next_max_id&gt;</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str): name of the user.</span>
<span class="sd">        n (int): maximum number of tagged posts, which should be collected. By</span>
<span class="sd">         default, it&#39;s 100. If it&#39;s set to 0, collect all posts.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: all visible tagged posts in json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_user_tagged_posts</span>
<span class="sd">        &gt;&gt;&gt; collect_user_tagged_posts(driver, &quot;instagram_username&quot;, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;n&#39; must be bigger than or equal to 0.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">/tagged&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/users/web_profile_info/?username=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">extract_id</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>

    <span class="c1"># get first 12 documents</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">doc_id</span><span class="o">=</span><span class="n">TAGGED_POST_DOC_ID</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">GRAPHQL_QUERY_PATH</span><span class="si">}</span><span class="s2">/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;edge_user_to_photos_of_you&quot;</span><span class="p">])</span>
    <span class="n">remaining</span> <span class="o">-=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>

    <span class="k">while</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;page_info&#39;</span><span class="p">][</span><span class="s1">&#39;has_next_page&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">footer</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//footer&quot;</span><span class="p">)</span>
        <span class="n">ActionChains</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span><span class="o">.</span><span class="n">scroll_to_element</span><span class="p">(</span><span class="n">footer</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;page_info&#39;</span><span class="p">][</span><span class="s1">&#39;end_cursor&#39;</span><span class="p">],</span> <span class="n">first</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">doc_id</span><span class="o">=</span><span class="n">TAGGED_POST_DOC_ID</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">GRAPHQL_QUERY_PATH</span><span class="si">}</span><span class="s2">/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;edge_user_to_photos_of_you&quot;</span><span class="p">])</span>
        <span class="n">remaining</span> <span class="o">-=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>

    <span class="n">tagged_posts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span>

            <span class="n">caption</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;edge_media_to_caption&#39;</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">]:</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="n">Caption</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;edge_media_to_caption&#39;</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;node&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>

            <span class="n">user</span> <span class="o">=</span> <span class="n">UserBasicInfo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">extract_id</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;owner&quot;</span><span class="p">]),</span>
                                 <span class="n">username</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;owner&quot;</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">])</span>

            <span class="n">post</span> <span class="o">=</span> <span class="n">PostBasicInfo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">extract_id</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
                                 <span class="n">code</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;shortcode&#39;</span><span class="p">],</span>
                                 <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                                 <span class="n">taken_at</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;taken_at_timestamp&#39;</span><span class="p">],</span>
                                 <span class="n">media_type</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;__typename&#39;</span><span class="p">],</span>
                                 <span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">,</span>
                                 <span class="n">accessibility_caption</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;accessibility_caption&#39;</span><span class="p">],</span>
                                 <span class="n">original_width</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">],</span>
                                 <span class="n">original_height</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
                                 <span class="n">urls</span><span class="o">=</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;display_url&quot;</span><span class="p">]],</span>
                                 <span class="n">like_count</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;edge_media_preview_like&#39;</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">],</span>
                                 <span class="n">comment_count</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;edge_media_to_comment&#39;</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
            <span class="n">tagged_posts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="n">tagged_posts</span> <span class="o">=</span> <span class="n">tagged_posts</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Posts</span><span class="p">(</span><span class="n">posts</span><span class="o">=</span><span class="n">tagged_posts</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tagged_posts</span><span class="p">))</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_friendship_status"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.get_friendship_status">[docs]</a><span class="k">def</span> <span class="nf">get_friendship_status</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                          <span class="n">username1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">username2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the relationship between any two users.</span>

<span class="sd">    Strategy: the only way to do it is to check if user_A is contained in</span>
<span class="sd">    user_B&#39;s followings or followers.</span>

<span class="sd">    Args:</span>
<span class="sd">        username1 (str): username of the person A.</span>
<span class="sd">        username2 (str): username of the person B.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: friendship indication between person A and person B.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: the logic of getting following or follower should check followers</span>
    <span class="c1">#  and followings and taken into account of is_private account</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">following</span><span class="p">,</span> <span class="n">followed_by</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="p">[</span><span class="n">username1</span><span class="p">,</span> <span class="n">username2</span><span class="p">]:</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

        <span class="c1"># get user data</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/users/web_profile_info/?username=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
        <span class="n">user_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">extract_id</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>

        <span class="n">following_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;//a[@href=&#39;/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">/following/&#39;][@role=&#39;link&#39;]&quot;</span><span class="p">)</span>
        <span class="n">following_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

        <span class="c1"># get first 12 followings</span>
        <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/friendships/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">/following/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">user_info</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="n">username1</span><span class="p">,</span> <span class="n">username2</span><span class="p">}:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">username1</span><span class="p">:</span>
                <span class="n">following</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">followed_by</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

        <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="s1">&#39;next_max_id&#39;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">:</span>

            <span class="n">following_bottom</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//div[@class=&#39;_aano&#39;]//div[@role=&#39;progressbar&#39;]&quot;</span><span class="p">)</span>
            <span class="n">ActionChains</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span><span class="o">.</span><span class="n">scroll_to_element</span><span class="p">(</span><span class="n">following_bottom</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

            <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

            <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_id</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;next_max_id&#39;</span><span class="p">])</span>
            <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/friendships/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">/following/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">user_info</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="n">username1</span><span class="p">,</span> <span class="n">username2</span><span class="p">}:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">username1</span><span class="p">:</span>
                    <span class="n">following</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">followed_by</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">FriendshipStatus</span><span class="p">(</span><span class="n">following</span><span class="o">=</span><span class="n">following</span><span class="p">,</span> <span class="n">followed_by</span><span class="o">=</span><span class="n">followed_by</span><span class="p">)</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_followers"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_followers">[docs]</a><span class="nd">@driver_implicit_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">collect_followers</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                      <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect n followers of the given user. Anyone besides the account owner</span>
<span class="sd">    can get maximal 50 followers.</span>

<span class="sd">    Strategy: click the username, get to the main page of the user, then click</span>
<span class="sd">    followers, a list of followers of the user shows in a popup. A request</span>
<span class="sd">    triggered by the clicking was sent to the path</span>
<span class="sd">    `/api/v1/friendships/&lt;user_id&gt;/followers/?count=12&amp;search_surface=follow_list_page`.</span>

<span class="sd">    Args:</span>
<span class="sd">        driver (:obj:`selenium.webdriver.remote.webdriver.WebDriver`): selenium</span>
<span class="sd">         driver for controlling the browser to perform certain actions.</span>
<span class="sd">        username (str): name of the user.</span>
<span class="sd">        n (int): maximum number of followers, which should be collected. By default,</span>
<span class="sd">         it&#39;s 100. If it&#39;s set to 0, collect all followers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: all visible followers&#39; user information of the given user in json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_followers</span>
<span class="sd">        &gt;&gt;&gt; collect_followers(driver, &quot;instagram_username&quot;, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;n&#39; must be bigger than or equal to 0.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="c1"># get user data</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/users/web_profile_info/?username=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">extract_id</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>

    <span class="n">followers_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;//a[@href=&#39;/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">/followers/&#39;][@role=&#39;link&#39;]&quot;</span><span class="p">)</span>
    <span class="n">followers_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="c1"># get 50 followers</span>
    <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">search_surface</span><span class="o">=</span><span class="s2">&quot;follow_list_page&quot;</span><span class="p">)</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/friendships/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">/followers/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>

    <span class="k">while</span> <span class="s1">&#39;next_max_id&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">followers_bottom</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//div[@class=&#39;_aano&#39;]//div[@role=&#39;progressbar&#39;]&quot;</span><span class="p">)</span>
        <span class="n">ActionChains</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span><span class="o">.</span><span class="n">scroll_to_element</span><span class="p">(</span><span class="n">followers_bottom</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

        <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_id</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;next_max_id&#39;</span><span class="p">])</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/friendships/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">/following/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>

    <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">json_data</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">user_info</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span>
                               <span class="n">username</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                               <span class="n">fullname</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">],</span>
                               <span class="n">profile_pic_url</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;profile_pic_url&quot;</span><span class="p">],</span>
                               <span class="n">is_private</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;is_private&quot;</span><span class="p">],</span>
                               <span class="n">is_verified</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;is_verified&quot;</span><span class="p">])</span>
            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">users</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Users</span><span class="p">(</span><span class="n">users</span><span class="o">=</span><span class="n">users</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">))</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_followings"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_followings">[docs]</a><span class="nd">@driver_implicit_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">collect_followings</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                       <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect n followings of the given user.</span>

<span class="sd">    Strategy: click the username, get to the main page of the user, then click following, a list of</span>
<span class="sd">    following of the user shows in a popup. A request triggered by the clicking was sent to the path</span>
<span class="sd">    `/api/v1/friendships/373735170/following/?count=12`.</span>

<span class="sd">    Args:</span>
<span class="sd">        driver (:obj:`selenium.webdriver.remote.webdriver.WebDriver`): selenium</span>
<span class="sd">         driver for controlling the browser to perform certain actions.</span>
<span class="sd">        username (str): name of the user.</span>
<span class="sd">        n (int): maximum number of followings, which should be collected. By default,</span>
<span class="sd">         it&#39;s 100. If it&#39;s set to 0, collect all followings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: all visible followings&#39; user information of the given user in json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_followings</span>
<span class="sd">        &gt;&gt;&gt; collect_followings(driver, &quot;instagram_username&quot;, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;n&#39; must be bigger than or equal to 0.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="c1"># get user data</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/users/web_profile_info/?username=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">extract_id</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>

    <span class="n">following_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;//a[@href=&#39;/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">/following/&#39;][@role=&#39;link&#39;]&quot;</span><span class="p">)</span>
    <span class="n">following_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="c1"># get first 12 followings</span>
    <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/friendships/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">/following/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>

    <span class="k">while</span> <span class="s1">&#39;next_max_id&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">following_bottom</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//div[@class=&#39;_aano&#39;]//div[@role=&#39;progressbar&#39;]&quot;</span><span class="p">)</span>
        <span class="n">ActionChains</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span><span class="o">.</span><span class="n">scroll_to_element</span><span class="p">(</span><span class="n">following_bottom</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

        <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_id</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;next_max_id&#39;</span><span class="p">])</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/friendships/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">/following/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>

    <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">json_data</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">user_info</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span>
                               <span class="n">username</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                               <span class="n">fullname</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">],</span>
                               <span class="n">profile_pic_url</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;profile_pic_url&quot;</span><span class="p">],</span>
                               <span class="n">is_private</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;is_private&quot;</span><span class="p">],</span>
                               <span class="n">is_verified</span><span class="o">=</span><span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;is_verified&quot;</span><span class="p">])</span>
            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">users</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Users</span><span class="p">(</span><span class="n">users</span><span class="o">=</span><span class="n">users</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">))</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_following_hashtags"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_following_hashtags">[docs]</a><span class="nd">@driver_implicit_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">collect_following_hashtags</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                               <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect n followings hashtags of the given user.</span>

<span class="sd">    Strategy: click the username, get to the main page of the user, then click</span>
<span class="sd">    following and click hashtags, a list of following hashtags of the user shows</span>
<span class="sd">    in a popup. A request triggered by the clicking was sent to the path</span>
<span class="sd">    `/api/v1/friendships/373735170/following/?count=12`.</span>

<span class="sd">    Args:</span>
<span class="sd">        driver (:obj:`selenium.webdriver.remote.webdriver.WebDriver`): selenium</span>
<span class="sd">         driver for controlling the browser to perform certain actions.</span>
<span class="sd">        username (str): name of the user.</span>
<span class="sd">        n (int): maximum number of followings, which should be collected.</span>
<span class="sd">         By default, it&#39;s 100. If it&#39;s set to 0, collect all followings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: all visible followings hashtags&#39; information of the given user in</span>
<span class="sd">        json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_following_hashtags</span>
<span class="sd">        &gt;&gt;&gt; collect_following_hashtags(driver, &quot;instagram_username&quot;, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;n&#39; must be bigger than or equal to 0.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/users/web_profile_info/?username=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">extract_id</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>

    <span class="n">following_btn_xpath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;//a[@href=&#39;/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">/following/&#39;][@role=&#39;link&#39;]&quot;</span>
    <span class="n">following_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="n">following_btn_xpath</span><span class="p">)</span>
    <span class="n">following_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">hashtag_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//span[text()=&#39;Hashtags&#39;]&quot;</span><span class="p">)</span>
    <span class="n">hashtag_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="c1"># get first 12 followings</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">doc_id</span><span class="o">=</span><span class="n">FOLLOWING_DOC_ID</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">GRAPHQL_QUERY_PATH</span><span class="si">}</span><span class="s2">/?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query_dict</span><span class="p">,</span><span class="w"> </span><span class="n">quote_via</span><span class="o">=</span><span class="n">quote</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;edge_following_hashtag&#39;</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">])</span>

    <span class="c1"># TODO: finish fetching more hashtags</span>
    <span class="c1"># while remaining &gt; 0 and not results[-1][&#39;extensions&#39;][&#39;is_final&#39;]:</span>
    <span class="c1">#     following_bottom = driver.find_element(By.XPATH, &quot;//div[@class=&#39;_aabq&#39;]&quot;)</span>
    <span class="c1">#     driver.execute_script(&quot;arguments[0].scrollTop = arguments[0].scrollHeight&quot;, following_bottom)</span>
    <span class="c1">#</span>
    <span class="c1">#     time.sleep(random.randint(4, 6))</span>
    <span class="c1">#     target_url = f&quot;{INSTAGRAM_DOMAIN}/{GRAPHQL_QUERY_PATH}/?doc_id={FOLLOWING_DOC_ID}&amp;variables=%7B%22id%22%3A%22{user_id}%22%7D&quot;</span>
    <span class="c1">#     request = filter_request(driver.requests, target_url)</span>
    <span class="c1">#     if not request:</span>
    <span class="c1">#         raise ValueError(f&quot;No json response to the url &#39;{target_url}&#39; found.&quot;)</span>
    <span class="c1">#     json_data = get_json_data(request.response)</span>
    <span class="c1">#     results.append(json_data)</span>
    <span class="c1">#     remaining -= 12</span>
    <span class="c1">#     del driver.requests</span>

    <span class="n">hashtags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">json_data</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;edge_following_hashtag&#39;</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">]:</span>
            <span class="n">hashtag</span> <span class="o">=</span> <span class="n">HashtagBasicInfo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">extract_id</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]),</span>
                                       <span class="n">name</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                                       <span class="n">post_count</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">][</span><span class="s2">&quot;media_count&quot;</span><span class="p">],</span>
                                       <span class="n">profile_pic_url</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">][</span><span class="s2">&quot;profile_pic_url&quot;</span><span class="p">])</span>
            <span class="n">hashtags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashtag</span><span class="p">)</span>
    <span class="n">hashtags</span> <span class="o">=</span> <span class="n">hashtags</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">HashtagBasicInfos</span><span class="p">(</span><span class="n">hashtags</span><span class="o">=</span><span class="n">hashtags</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">hashtags</span><span class="p">))</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_likers_of_post"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_likers_of_post">[docs]</a><span class="nd">@driver_implicit_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">collect_likers_of_post</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                           <span class="n">post_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect the users, who likes a given post.</span>

<span class="sd">    Strategy: click the likes (a button with link `/p/&lt;post_code&gt;/liked_by/`), a</span>
<span class="sd">    list of likers shows in a popup.</span>
<span class="sd">    A request triggered by the clicking was sent to the path `/api/v1/media/&lt;post_id&gt;/likers/`</span>

<span class="sd">    Args:</span>
<span class="sd">        post_code (str): post code, used for generating post directly accessible url.</span>
<span class="sd">        n (int): maximum number of likers, which should be collected. By default,</span>
<span class="sd">         it&#39;s 100. If it&#39;s set to 0, collect all likers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: all likers&#39; user information of the given post in json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_likers_of_post</span>
<span class="sd">        &gt;&gt;&gt; collect_likers_of_post(driver, &quot;WGDBS3D&quot;, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;n&#39; must be bigger than or equal to 0.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/p/</span><span class="si">{</span><span class="n">post_code</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="c1"># get the media id for later requests filtering</span>
    <span class="n">meta_tag_xpath</span> <span class="o">=</span> <span class="s2">&quot;//meta[@property=&#39;al:ios:url&#39;]&quot;</span>
    <span class="n">meta_tag</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="n">meta_tag_xpath</span><span class="p">)</span>
    <span class="n">media_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">meta_tag</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">media_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Likers</span><span class="p">(</span><span class="n">likers</span><span class="o">=</span><span class="p">[],</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>
    <span class="n">media_id</span> <span class="o">=</span> <span class="n">media_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">likes_btn_xpath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;//a[@href=&#39;/p/</span><span class="si">{</span><span class="n">post_code</span><span class="si">}</span><span class="s2">/liked_by/&#39;][@role=&#39;link&#39;]&quot;</span>
    <span class="n">likes_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="n">likes_btn_xpath</span><span class="p">)</span>
    <span class="n">likes_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="c1"># get 50 likers</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/media/</span><span class="si">{</span><span class="n">media_id</span><span class="si">}</span><span class="s2">/likers/&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

    <span class="n">likers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">json_data</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">liker_info</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
            <span class="n">friendship_status</span> <span class="o">=</span> <span class="n">FriendshipStatus</span><span class="p">(</span><span class="n">following</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;following&quot;</span><span class="p">],</span>
                                                 <span class="n">followed_by</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;followed_by&quot;</span><span class="p">],</span>
                                                 <span class="n">blocking</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;blocking&quot;</span><span class="p">],</span>
                                                 <span class="n">muting</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;muting&quot;</span><span class="p">],</span>
                                                 <span class="n">is_private</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;is_private&quot;</span><span class="p">],</span>
                                                 <span class="n">incoming_request</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;incoming_request&quot;</span><span class="p">],</span>
                                                 <span class="n">outgoing_request</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;outgoing_request&quot;</span><span class="p">],</span>
                                                 <span class="n">is_blocking_reel</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;is_blocking_reel&quot;</span><span class="p">],</span>
                                                 <span class="n">is_muting_reel</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;is_muting_reel&quot;</span><span class="p">],</span>
                                                 <span class="n">is_bestie</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;is_bestie&quot;</span><span class="p">],</span>
                                                 <span class="n">is_restricted</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;is_restricted&quot;</span><span class="p">],</span>
                                                 <span class="n">is_feed_favorite</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;is_feed_favorite&quot;</span><span class="p">],</span>
                                                 <span class="n">subscribed</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span><span class="s2">&quot;subscribed&quot;</span><span class="p">],</span>
                                                 <span class="n">is_eligible_to_subscribe</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;friendship_status&quot;</span><span class="p">][</span>
                                                     <span class="s2">&quot;is_eligible_to_subscribe&quot;</span><span class="p">])</span>
            <span class="n">liker</span> <span class="o">=</span> <span class="n">Liker</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span>
                          <span class="n">username</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                          <span class="n">fullname</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">],</span>
                          <span class="n">profile_pic_url</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;profile_pic_url&quot;</span><span class="p">],</span>
                          <span class="n">is_private</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;is_private&quot;</span><span class="p">],</span>
                          <span class="n">is_verified</span><span class="o">=</span><span class="n">liker_info</span><span class="p">[</span><span class="s2">&quot;is_verified&quot;</span><span class="p">],</span>
                          <span class="n">friendship_status</span><span class="o">=</span><span class="n">friendship_status</span><span class="p">)</span>
            <span class="n">likers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">liker</span><span class="p">)</span>
    <span class="n">likers</span> <span class="o">=</span> <span class="n">likers</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Likers</span><span class="p">(</span><span class="n">likers</span><span class="o">=</span><span class="n">likers</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">likers</span><span class="p">))</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_comments"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_comments">[docs]</a><span class="k">def</span> <span class="nf">collect_comments</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                     <span class="n">post_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect n comments of a given post.</span>

<span class="sd">    Strategy: click the post (a button with link `/p/&lt;post_code&gt;/`), a list of</span>
<span class="sd">    comments shows in a popup. A request triggered by the clicking was sent to the path</span>
<span class="sd">    `/api/v1/post/&lt;post_id&gt;/comments/?can_support_threading=true&amp;permalink_enabled=false`</span>
<span class="sd">    The comments are paginated, to load more comments, have to use the mouse to click</span>
<span class="sd">    a button to load more comments.</span>

<span class="sd">    Args:</span>
<span class="sd">        post_id (str): id of the post, whose comments will be collected.</span>
<span class="sd">        n (int): maximum number of comments, which should be collected. By default,</span>
<span class="sd">         it&#39;s 100. If it&#39;s set to 0, collect all comments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: all comments of the given post in json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_comments</span>
<span class="sd">        &gt;&gt;&gt; collect_comments(driver, &quot;WGDBS3D&quot;, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Comments</span><span class="p">(</span><span class="n">comments</span><span class="o">=</span><span class="p">[],</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="search_with_keyword"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.search_with_keyword">[docs]</a><span class="k">def</span> <span class="nf">search_with_keyword</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                        <span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">pers</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search hashtags or users with given keyword.</span>

<span class="sd">    Args:</span>
<span class="sd">        keyword (str): keyword for searching.</span>
<span class="sd">        pers (bool): indicating whether results should be personalized or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: found users/hashtags.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import search_with_keyword</span>
<span class="sd">        &gt;&gt;&gt; search_with_keyword(driver, &quot;asian games&quot;, True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">search_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s1">&#39;//a[@href=&quot;#&quot;][@role=&quot;link&quot;]&#39;</span><span class="p">)</span>
    <span class="n">search_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="n">search_input_box</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s1">&#39;//input[@aria-label=&quot;Search input&quot;][@placeholder=&quot;Search&quot;][@type=&quot;text&quot;]&#39;</span><span class="p">)</span>
    <span class="n">search_input_box</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pers</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>
        <span class="n">not_pers_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s1">&#39;//div[@aria-label=&quot;Not personalised&quot;][@role=&quot;button&quot;][@tabindex=&quot;0&quot;]//span[text()=&quot;Not personalised&quot;]&#39;</span><span class="p">)</span>
        <span class="n">not_pers_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">,</span> <span class="n">response_content_type</span><span class="o">=</span><span class="s2">&quot;text/javascript; charset=utf-8&quot;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/api/graphql&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">json_requests</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No requests to search.&quot;</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">json_requests</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">!=</span> <span class="n">target_url</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;variables&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">pers</span> <span class="ow">and</span> <span class="n">variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">))[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">keyword</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">pers</span> <span class="ow">and</span> <span class="n">variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">keyword</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No json response to the url &#39;</span><span class="si">{</span><span class="n">target_url</span><span class="si">}</span><span class="s2">&#39; found.&quot;</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">data_key</span> <span class="o">=</span> <span class="s2">&quot;xdt_api__v1__fbsearch__topsearch_connection&quot;</span> <span class="k">if</span> <span class="n">pers</span> <span class="k">else</span> <span class="s2">&quot;xdt_api__v1__fbsearch__non_profiled_serp&quot;</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span>
    <span class="n">hashtags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">places</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">pers</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">hashtag_info</span> <span class="ow">in</span> <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hashtags&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">hashtag</span> <span class="o">=</span> <span class="n">SearchingResultHashtag</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">hashtag_info</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                                             <span class="n">hashtag</span><span class="o">=</span><span class="n">HashtagBasicInfo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">extract_id</span><span class="p">(</span><span class="n">hashtag_info</span><span class="p">[</span><span class="s2">&quot;hashtag&quot;</span><span class="p">]),</span>
                                                                      <span class="n">name</span><span class="o">=</span><span class="n">hashtag_info</span><span class="p">[</span><span class="s2">&quot;hashtag&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                                                                      <span class="n">post_count</span><span class="o">=</span><span class="n">hashtag_info</span><span class="p">[</span><span class="s2">&quot;hashtag&quot;</span><span class="p">][</span><span class="s2">&quot;media_count&quot;</span><span class="p">]))</span>
            <span class="n">hashtags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashtag</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">place_info</span> <span class="ow">in</span> <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;places&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">place</span> <span class="o">=</span> <span class="n">SearchingResultPlace</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">place_info</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                                         <span class="n">place</span><span class="o">=</span><span class="n">Place</span><span class="p">(</span>
                                             <span class="n">location</span><span class="o">=</span><span class="n">LocationBasicInfo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">place_info</span><span class="p">[</span><span class="s2">&quot;place&quot;</span><span class="p">][</span><span class="s2">&quot;location&quot;</span><span class="p">][</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span>
                                                                        <span class="n">name</span><span class="o">=</span><span class="n">place_info</span><span class="p">[</span><span class="s2">&quot;place&quot;</span><span class="p">][</span><span class="s2">&quot;location&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
                                             <span class="n">subtitle</span><span class="o">=</span><span class="n">place_info</span><span class="p">[</span><span class="s2">&quot;place&quot;</span><span class="p">][</span><span class="s2">&quot;subtitle&quot;</span><span class="p">],</span>
                                             <span class="n">title</span><span class="o">=</span><span class="n">place_info</span><span class="p">[</span><span class="s2">&quot;place&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]))</span>
            <span class="n">places</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">place</span><span class="p">)</span>

    <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">[])):</span>
        <span class="k">if</span> <span class="n">pers</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
            <span class="n">user_info_dict</span> <span class="o">=</span> <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">user_info_dict</span> <span class="o">=</span> <span class="n">user_info</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">SearchingResultUser</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
                                   <span class="n">user</span><span class="o">=</span><span class="n">UserProfile</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">extract_id</span><span class="p">(</span><span class="n">user_info_dict</span><span class="p">),</span>
                                                    <span class="n">username</span><span class="o">=</span><span class="n">user_info_dict</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                                                    <span class="n">fullname</span><span class="o">=</span><span class="n">user_info_dict</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">],</span>
                                                    <span class="n">profile_pic_url</span><span class="o">=</span><span class="n">user_info_dict</span><span class="p">[</span><span class="s2">&quot;profile_pic_url&quot;</span><span class="p">],</span>
                                                    <span class="n">is_verified</span><span class="o">=</span><span class="n">user_info_dict</span><span class="p">[</span><span class="s2">&quot;is_verified&quot;</span><span class="p">]))</span>
        <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">searching_result</span> <span class="o">=</span> <span class="n">SearchingResult</span><span class="p">(</span><span class="n">hashtags</span><span class="o">=</span><span class="n">hashtags</span><span class="p">,</span>
                                       <span class="n">users</span><span class="o">=</span><span class="n">users</span><span class="p">,</span>
                                       <span class="n">places</span><span class="o">=</span><span class="n">places</span><span class="p">,</span>
                                       <span class="n">personalised</span><span class="o">=</span><span class="n">pers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">searching_result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_hashtag_top_posts"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_hashtag_top_posts">[docs]</a><span class="k">def</span> <span class="nf">collect_hashtag_top_posts</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                              <span class="n">hashtag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect top posts of a given hashtag.</span>

<span class="sd">    Strategy: click the search button from the left navigation bar, and input the hashtag in</span>
<span class="sd">    the searchbar, and select the desired hashtag from searching results. This action will</span>
<span class="sd">    trigger a request sent to the path `/api/v1/tags/web_info/?tag_name=&lt;tag name&gt;`, as result</span>
<span class="sd">    the top posts are showed.</span>

<span class="sd">    Args:</span>
<span class="sd">        hashtag (str): hashtag.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: Hashtag information in a json format.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_hashtag_top_posts</span>
<span class="sd">        &gt;&gt;&gt; collect_hashtag_top_posts(driver, &quot;asiangames&quot;, True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/explore/tags/</span><span class="si">{</span><span class="n">hashtag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s1">/tags/web_info/?tag_name=</span><span class="si">{</span><span class="n">hashtag</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>

    <span class="n">posts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;top&quot;</span><span class="p">][</span><span class="s2">&quot;sections&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">section</span><span class="p">[</span><span class="s2">&quot;layout_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;one_by_two_left&quot;</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">section</span><span class="p">[</span><span class="s2">&quot;layout_content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fill_items&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">items</span> <span class="o">+=</span> <span class="n">section</span><span class="p">[</span><span class="s2">&quot;layout_content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;one_by_two_item&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;clips&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">section</span><span class="p">[</span><span class="s2">&quot;layout_content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;medias&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">extract_post</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;media&quot;</span><span class="p">])</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>

    <span class="n">tag</span> <span class="o">=</span> <span class="n">Hashtag</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">extract_id</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                  <span class="n">post_count</span><span class="o">=</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;media_count&quot;</span><span class="p">],</span>
                  <span class="n">profile_pic_url</span><span class="o">=</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;profile_pic_url&quot;</span><span class="p">],</span>
                  <span class="n">is_trending</span><span class="o">=</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;is_trending&quot;</span><span class="p">],</span>
                  <span class="n">related_tags</span><span class="o">=</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;related_tags&quot;</span><span class="p">],</span>
                  <span class="n">subtitle</span><span class="o">=</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;subtitle&quot;</span><span class="p">],</span>
                  <span class="n">posts</span><span class="o">=</span><span class="n">posts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tag</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_posts_by_music_id"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.collect_posts_by_music_id">[docs]</a><span class="k">def</span> <span class="nf">collect_posts_by_music_id</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                              <span class="n">music_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search for all posts containing the given music_id.</span>

<span class="sd">    Strategy: the only way to collect the posts using the same music, is to first find</span>
<span class="sd">    a post with this music, then click the link &quot;original audio&quot; to get all the posts</span>
<span class="sd">    using this music.</span>

<span class="sd">    The request was sent to the path /reels/audio/&lt;music_id&gt;/.</span>

<span class="sd">    Args:</span>
<span class="sd">        music_id (str): id of the music.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Json: a list of posts containing the music.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import collect_posts_by_music_id</span>
<span class="sd">        &gt;&gt;&gt; collect_posts_by_music_id(driver, &quot;664212705901923&quot;, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">find_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">music_id</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">json_requests</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No requests to search.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">json_requests</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">!=</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">request_data</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">first</span> <span class="ow">and</span> <span class="s2">&quot;max_id&quot;</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">first</span> <span class="ow">and</span> <span class="s2">&quot;max_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="s1">&#39;audio_cluster_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">request_data</span><span class="p">[</span><span class="s2">&quot;audio_cluster_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">music_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">return</span> <span class="n">i</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No json response to the url &#39;</span><span class="si">{</span><span class="n">target_url</span><span class="si">}</span><span class="s2">&#39; found.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;n&#39; must be bigger than or equal to 0.&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s1">/reels/audio/</span><span class="si">{</span><span class="n">music_id</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">json_requests</span> <span class="o">=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>
    <span class="c1"># get first 12 documents</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INSTAGRAM_DOMAIN</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">API_VERSION</span><span class="si">}</span><span class="s2">/clips/music/&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">find_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">,</span> <span class="n">music_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span>

    <span class="k">while</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;paging_info&quot;</span><span class="p">][</span><span class="s1">&#39;more_available&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">footer</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//footer&quot;</span><span class="p">)</span>
        <span class="n">ActionChains</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span><span class="o">.</span><span class="n">scroll_to_element</span><span class="p">(</span><span class="n">footer</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">json_requests</span> <span class="o">+=</span> <span class="n">filter_requests</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">find_request</span><span class="p">(</span><span class="n">json_requests</span><span class="p">,</span> <span class="n">target_url</span><span class="p">,</span> <span class="n">music_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">json_requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_json_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span>

    <span class="n">posts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">extract_post</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;media&quot;</span><span class="p">])</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
    <span class="n">media_count</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;media_count&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;music_info&quot;</span><span class="p">):</span>
        <span class="n">music_basic</span> <span class="o">=</span> <span class="n">extract_music_info</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;music_info&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">music_basic</span> <span class="o">=</span> <span class="n">extract_sound_info</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;original_sound_info&quot;</span><span class="p">])</span>
    <span class="n">music</span> <span class="o">=</span> <span class="n">Music</span><span class="p">(</span><span class="o">**</span><span class="n">music_basic</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
                  <span class="n">clips_count</span><span class="o">=</span><span class="n">media_count</span><span class="p">[</span><span class="s2">&quot;clips_count&quot;</span><span class="p">],</span>
                  <span class="n">photos_count</span><span class="o">=</span><span class="n">media_count</span><span class="p">[</span><span class="s2">&quot;photos_count&quot;</span><span class="p">])</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">posts</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">MusicPosts</span><span class="p">(</span><span class="n">posts</span><span class="o">=</span><span class="n">posts</span><span class="p">,</span> <span class="n">music</span><span class="o">=</span><span class="n">music</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">posts</span><span class="p">))</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="download_media"><a class="viewcode-back" href="../../02_source.html#crawlinsta.collecting.download_media">[docs]</a><span class="k">def</span> <span class="nf">download_media</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Chrome</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Firefox</span><span class="p">,</span> <span class="n">Safari</span><span class="p">,</span> <span class="n">Remote</span><span class="p">],</span>
                   <span class="n">media_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download the image/video based on the given media_url, and store it to</span>
<span class="sd">    the given path.</span>

<span class="sd">    Args:</span>
<span class="sd">        media_url (str): url of the media for downloading.</span>
<span class="sd">        path (str): path for storing the downloaded media..</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta import webdriver</span>
<span class="sd">        &gt;&gt;&gt; driver = webdriver.Chrome(&#39;path_to_chromedriver&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.login import login</span>
<span class="sd">        &gt;&gt;&gt; login(driver, &quot;your_username&quot;, &quot;your_password&quot;)</span>
<span class="sd">        &gt;&gt;&gt; from crawlinsta.collecting import download_media</span>
<span class="sd">        &gt;&gt;&gt; download_media(driver, &quot;https://scontent-muc2-1.xx.fbcdn.net/v/t39.12897-6/419784899_922911948795613_3855576336552877996_n.m4a&quot;, &quot;tmp&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">media_url</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No requests to filter.&quot;</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">driver</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="s1">&#39;content-type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">req</span><span class="o">.</span><span class="n">url</span> <span class="o">!=</span> <span class="n">media_url</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">req</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Media from </span><span class="si">{</span><span class="n">media_url</span><span class="si">}</span><span class="s2"> cannot be downloaded.&quot;</span><span class="p">)</span>
    <span class="n">file_extension</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">file_extension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Zhiwei Zhang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>